<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reservar turno | LDMS STUDIO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  <style>
    :root {
      --bg: #0f0f0f;
      --card: #151515;
      --primary: #f5c542;
      --accent: #f0a500;
      --text: #ffffff;
      --muted: #9a9a9a;
      --radius: 18px;
      --ok: #36d399;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #1f1f1f, #0a0a0a 60%);
      color: var(--text);
      display: flex; align-items: center; justify-content: center; padding: 16px;
    }
    .container {
      width: 100%; max-width: 420px;
      background: linear-gradient(180deg, #1a1a1a, #0f0f0f);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: 0 20px 40px rgba(0,0,0,.6);
    }
    .header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .back { background: transparent; border: none; color: var(--primary); font-size: .95rem; cursor: pointer; }
    .title { flex: 1; text-align: center; font-weight: 800; letter-spacing: 1px; }

    .step { display: none; }
    .step.active { display: block; }

    .section { margin-top: 12px; }
    .section h3 { font-size: .8rem; color: var(--muted); margin-bottom: 8px; letter-spacing: 1px; text-transform: uppercase; }

    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .item {
      padding: 12px 6px; border-radius: 12px; background: #1f1f1f;
      text-align: center; font-size: .9rem; cursor: pointer; border: 1px solid transparent;
    }
    .item.active { border-color: var(--primary); background: rgba(245,197,66,.15); }
    .item.disabled { opacity:.3; pointer-events:none; }

    .services { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .service {
      padding: 12px; border-radius: 12px; background: #1f1f1f; border: 1px solid transparent;
      cursor: pointer; font-size: .9rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    .service.active { border-color: var(--primary); background: rgba(245,197,66,.15); }

    .btn {
      width: 100%; padding: 14px; border-radius: 14px; border: none; cursor: pointer;
      background: linear-gradient(135deg, #f5c542, #f0a500); color: #000; font-weight: 800;
      box-shadow: 0 10px 24px rgba(245,197,66,.35); margin-top: 12px;
    }
    .btn.secondary { background: #1f1f1f; color: var(--text); box-shadow: none; border: 1px solid #2a2a2a; }

    .resume {
      background: #121212; border-radius: 12px; padding: 12px; font-size: .9rem; line-height: 1.5;
    }
    .success {
      text-align: center; padding: 18px; border-radius: 14px;
      background: linear-gradient(180deg, #0f1f18, #0b1612);
      border: 1px solid rgba(54,211,153,.4);
      color: #c9f7e6;
      margin-top: 10px;
    }
    .note { font-size: .75rem; color: #777; text-align: center; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="back" onclick="volver()">‚Üê Volver</button>
      <div class="title">Reservar turno</div>
      <div style="width:32px"></div>
    </div>

    <div class="step active" id="step-mes">
      <div class="section">
        <h3>Eleg√≠ el mes</h3>
        <div class="grid" id="meses"></div>
      </div>
      <button class="btn" onclick="next('dia')">Continuar</button>
    </div>

    <div class="step" id="step-dia">
      <div class="section">
        <h3>Eleg√≠ el d√≠a</h3>
        <div class="grid" id="dias"></div>
      </div>
      <button class="btn secondary" onclick="prev('mes')">Atr√°s</button>
      <button class="btn" onclick="next('servicios')">Continuar</button>
    </div>

    <div class="step" id="step-servicios">
      <div class="section">
        <h3>¬øQu√© te quer√©s hacer?</h3>
        <div class="services" id="services"></div>
      </div>
      <button class="btn secondary" onclick="prev('dia')">Atr√°s</button>
      <button class="btn" onclick="next('resumen')">Continuar</button>
    </div>

    <div class="step" id="step-resumen">
      <div class="section">
        <h3>Resumen de tu cita</h3>
        <div class="resume" id="resumenBox"></div>
      </div>
      <button class="btn secondary" onclick="prev('servicios')">Atr√°s</button>
      <button class="btn" onclick="confirmar()">Confirmar turno</button>

      <div class="success" id="success" style="display:none;">
        ‚úÖ ¬°Turno confirmado! <br/>
        Te esperamos en <b>LDMS STUDIO</b>. <br/>
        Recomendamos sacar captura de esta pantalla.
        <br/><br/>
        <button class="btn" onclick="volver()">Volver al men√∫</button>
      </div>
      <div class="note">Direcci√≥n: Av. Artigas 1234</div>
    </div>
  </div>

  <script>
    const now = new Date();
    const year = now.getFullYear();
    const currentMonth = now.getMonth();
    const currentDay = now.getDate();

    const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    const servicios = [
      { id: "corte", label: "Corte de pelo" },
      { id: "barba", label: "Barba" },
      { id: "cejas", label: "Cejas" },
      { id: "perfilado", label: "Perfilado" },
      { id: "lavado", label: "Lavado" },
      { id: "combo", label: "Combo corte + barba" }
    ];

    let selMes = null;
    let selDia = null;
    let selServicios = new Set();
    let turnosOcupados = [];

    const mesesBox = document.getElementById("meses");
    const diasBox = document.getElementById("dias");
    const servicesBox = document.getElementById("services");
    const resumenBox = document.getElementById("resumenBox");

    // Traer turnos ocupados del backend (Railway)
    fetch("/api/turnos")
      .then(r => r.json())
      .then(data => { turnosOcupados = data; });

    meses.forEach((m, i) => {
      if (i < currentMonth) return;
      const d = document.createElement("div");
      d.className = "item";
      d.innerText = m;
      d.onclick = () => {
        document.querySelectorAll("#meses .item").forEach(x => x.classList.remove("active"));
        d.classList.add("active"); selMes = i;
        cargarDias();
      };
      mesesBox.appendChild(d);
    });

    function cargarDias(){
      diasBox.innerHTML = "";
      const lastDay = new Date(year, selMes+1, 0).getDate();

      for(let dNum=1; dNum<=lastDay; dNum++){
        const d = document.createElement("div");
        d.className = "item";
        d.innerText = dNum;

        if(selMes === currentMonth && dNum < currentDay) d.classList.add("disabled");

        const key = `${year}-${selMes}-${dNum}`;
        if (turnosOcupados.find(t => t.key === key)) d.classList.add("disabled");

        d.onclick = () => {
          document.querySelectorAll("#dias .item").forEach(x => x.classList.remove("active"));
          d.classList.add("active"); selDia = dNum;
        };
        diasBox.appendChild(d);
      }
    }

    servicios.forEach(s => {
      const d = document.createElement("div");
      d.className = "service";
      d.innerHTML = `<span>${s.label}</span><span>Ôºã</span>`;
      d.onclick = () => {
        if (selServicios.has(s.id)) {
          selServicios.delete(s.id);
          d.classList.remove("active");
          d.lastElementChild.innerText = "Ôºã";
        } else {
          selServicios.add(s.id);
          d.classList.add("active");
          d.lastElementChild.innerText = "‚úì";
        }
      };
      servicesBox.appendChild(d);
    });

    function next(step) {
      if (step === "dia" && selMes === null) return alert("Eleg√≠ un mes");
      if (step === "servicios" && !selDia) return alert("Eleg√≠ un d√≠a");
      if (step === "resumen" && selServicios.size === 0) return alert("Seleccion√° al menos un servicio");

      document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
      document.getElementById("step-" + step).classList.add("active");

      if (step === "resumen") {
        resumenBox.innerHTML = `
          <b>Estudio:</b> LDMS STUDIO<br/>
          <b>Fecha:</b> ${selDia} de ${meses[selMes]}<br/>
          <b>Servicios:</b> ${[...selServicios].map(id => servicios.find(s => s.id === id).label).join(", ")}
        `;
      }
    }

    function prev(step) {
      document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
      document.getElementById("step-" + step).classList.add("active");
    }

    // Confirmar: guardar en Railway y enviar a FormSpark
    async function confirmar() {
      const res = await fetch("/api/turnos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          year,
          mes: selMes,
          dia: selDia,
          servicios: [...selServicios]
        })
      });

      if (!res.ok) { alert("Ese turno ya fue reservado üò¨"); return; }

      // Enviar correo al barbero via FormSpark
      const fechaTexto = `${selDia} de ${meses[selMes]}`;
      const serviciosTexto = [...selServicios].map(id => servicios.find(s => s.id === id).label).join(", ");

      fetch("https://submit.formspark.io/mTOlSkwcE", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          estudio: "LDMS STUDIO",
          fecha: fechaTexto,
          servicios: serviciosTexto
        })
      }).then(fRes => { if(!fRes.ok) console.error("Error enviando a FormSpark"); })
        .catch(err => console.error("Error FormSpark:", err));

      document.getElementById("success").style.display = "block";
    }

    function volver() {
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
